<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>태스크 관리</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .selected-users {
            margin-top: 10px;
            padding: 8px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
        }
        .exempted {
            color: #ff6600;
            font-weight: bold;
        }
        .pending {
            color: #0066cc;
            font-style: italic;
        }
        .accepted {
            color: #008800;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h2>태스크 관리 (관리자)</h2>
    <form method="POST">
        <label for="title">태스크명:</label>
        <input type="text" name="title" id="title" required>
        <label for="description">설명:</label>
        <input type="text" name="description" id="description">
        <label for="required_count">필요 인원수:</label>
        <input type="number" name="required_count" id="required_count" min="1" required>
        <label>후보자 선택:</label><br>
        {% for user in users %}
            <input type="checkbox" name="candidates" value="{{ user.id }}"> {{ user.name }} ({{ user.email }})<br>
        {% endfor %}
        <button type="submit">태스크 생성</button>
    </form>
    <h3>태스크 목록</h3>
    <table>
        <tr>
            <th>태스크명</th><th>설명</th><th>필요 인원수</th><th>생성자</th><th>상태</th><th>후보자</th><th>생성일시</th><th>실행</th>
        </tr>
        {% for task in tasks %}
        <tr>
            <td>{{ task.title }}</td>
            <td>{{ task.description }}</td>
            <td>{{ task.required_count }}</td>
            <td>{{ task.created_by }}</td>
            <td>
                {% if task.status == 'completed' and task.id in task_statuses %}
                    <span style="color: {% if task_statuses[task.id] == '완료' %}green{% elif '추가 선정 필요' in task_statuses[task.id] %}red{% else %}orange{% endif %};">
                        {{ task_statuses[task.id] }}
                    </span>
                {% else %}
                    {{ task.status }}
                {% endif %}
            </td>
            <td>
                {% for c in task.candidates %}
                    {{ c.user.name }}{% if not loop.last %}, {% endif %}
                {% endfor %}
            </td>
            <td>{{ task.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>
                {% if task.status == 'pending' %}
                    <a href="/task/execute/{{ task.id }}">실행</a>
                {% elif task.id in needs_reselection %}
                    <a href="/task/execute/{{ task.id }}">추가 선정</a>
                {% else %}
                    -
                {% endif %}
            </td>
        </tr>
        {% if task.status == 'completed' and task.id in task_results %}
        <tr>
            <td colspan="8">
                <div class="selected-users">
                    <strong>선정 결과:</strong>
                    <ul>
                        {% for user in task_results[task.id] %}
                            <li class="{% if user.status == '면제됨' %}exempted{% elif user.status == '응답 대기 중' %}pending{% elif user.status == '수락됨' %}accepted{% endif %}">
                                {{ user.name }} - {{ user.status }}
                                {% if user.ticket_used %}
                                    (티켓 사용)
                                {% endif %}
                                {% if user.reason %}
                                    [{{ user.reason }}]
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </td>
        </tr>
        {% endif %}
        {% endfor %}
    </table>
    <p><a href="/dashboard">대시보드로</a></p>
</body>
</html> 